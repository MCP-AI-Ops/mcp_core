  GNU nano 7.2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /home/ubuntu/mcp_db/sql/schema.sql *
EhCREATE DATABASE IF NOT EXISTS mcp_autoscaler
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;

USE mcp_autoscaler;

-- ============================================
-- DOMAIN: User & Authentication
-- ============================================

-- 사용자 계정 테이블
CREATE TABLE users (
    user_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '사용자 고유 ID',

    -- 인증 정보
    email VARCHAR(255) NOT NULL COMMENT '이메일 (로그인 ID)',
    username VARCHAR(50) NOT NULL COMMENT '사용자명',
    password_hash VARCHAR(255) NOT NULL COMMENT '비밀번호 해시 (bcrypt)',

    -- 프로필 정보
    full_name VARCHAR(100) COMMENT '전체 이름',
    organization VARCHAR(100) COMMENT '소속 조직',

    -- 클라우드 계정 연동
    aws_account_id VARCHAR(50) COMMENT 'AWS 계정 ID',
    gcp_project_id VARCHAR(50) COMMENT 'GCP 프로젝트 ID',
    azure_subscription_id VARCHAR(50) COMMENT 'Azure 구독 ID',

    -- 상태 및 권한
    is_active BOOLEAN DEFAULT TRUE COMMENT '계정 활성화 상태',
    role ENUM('admin', 'user', 'viewer') DEFAULT 'user' COMMENT '사용자 권한',

    -- 타임스탬프
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '가입일',
    last_login_at TIMESTAMP NULL COMMENT '마지막 로그인',

    -- 제약 조건
    UNIQUE KEY uk_email (email),
    UNIQUE KEY uk_username (username),
    INDEX idx_active_users (is_active, created_at)

) ENGINE=InnoDB COMMENT='사용자 계정 관리';

-- ============================================
-- DOMAIN: Repository Analysis
-- ============================================

-- Git 레포지토리 정보
CREATE TABLE repositories (
    repo_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '레포지토리 고유 ID',
    user_id BIGINT UNSIGNED NOT NULL COMMENT '소유자 ID',

    -- 레포지토리 기본 정보
    repo_url VARCHAR(500) NOT NULL COMMENT 'Git 레포지토리 URL',
    repo_name VARCHAR(100) NOT NULL COMMENT '레포지토리 이름',
    repo_provider ENUM('github', 'gitlab', 'bitbucket') NOT NULL COMMENT 'Git 제공자',

    -- 분석 상태
    analysis_status ENUM('pending', 'analyzing', 'completed', 'failed')
        DEFAULT 'pending' COMMENT '분석 상태',
    analyzed_at TIMESTAMP NULL COMMENT '분석 완료 시간',

    -- 메타데이터
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '등록일',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정일',

    -- 제약 조건
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    INDEX idx_user_repos (user_id, created_at DESC),
    INDEX idx_repo_status (analysis_status)

) ENGINE=InnoDB COMMENT='Git 레포지토리 관리';

-- 레포지토리 분석 결과
CREATE TABLE repository_analysis (
    analysis_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '분석 고유 ID',
    repo_id BIGINT UNSIGNED NOT NULL COMMENT '레포지토리 ID',

    -- 코드 복잡도 메트릭
    total_lines_of_code INT UNSIGNED DEFAULT 0 COMMENT '전체 코드 라인 수',
    cyclomatic_complexity DECIMAL(8,2) DEFAULT 0 COMMENT '순환 복잡도',
    cognitive_complexity DECIMAL(8,2) DEFAULT 0 COMMENT '인지 복잡도',

    -- 기술 스택 분석
    primary_language VARCHAR(50) COMMENT '주 프로그래밍 언어',
    languages_distribution JSON COMMENT '언어별 비율 {"python": 60, "js": 40}',
    frameworks JSON COMMENT '사용 프레임워크 ["django", "react"]',

    -- 의존성 분석
    total_dependencies INT UNSIGNED DEFAULT 0 COMMENT '전체 의존성 개수',
    dependency_tree JSON COMMENT '의존성 트리 구조',
    security_vulnerabilities INT UNSIGNED DEFAULT 0 COMMENT '보안 취약점 개수',

    -- 프로젝트 규모
    total_files INT UNSIGNED DEFAULT 0 COMMENT '전체 파일 수',
    total_commits INT UNSIGNED DEFAULT 0 COMMENT '전체 커밋 수',
    active_contributors INT UNSIGNED DEFAULT 0 COMMENT '활성 기여자 수',

    -- 리소스 요구사항 추정 (MCP 클라이언트 산출값)
    estimated_base_cpu DECIMAL(5,2) NOT NULL COMMENT '기본 CPU 요구량 (vCPU)',
    estimated_base_memory DECIMAL(8,2) NOT NULL COMMENT '기본 메모리 요구량 (GB)',
    estimated_peak_multiplier DECIMAL(3,2) DEFAULT 2.0 COMMENT '피크 시간 배수',

    -- 프로젝트 유형 분류
    project_type ENUM('web_app', 'api', 'batch_job', 'ml_model', 'microservice', 'other')
        COMMENT '프로젝트 유형',
    deployment_complexity ENUM('low', 'medium', 'high', 'very_high')
        DEFAULT 'medium' COMMENT '배포 복잡도'
    -- 분석 메타데이터
    analysis_duration_seconds INT UNSIGNED COMMENT '분석 소요 시간',
    mcp_client_version VARCHAR(20) COMMENT 'MCP 클라이언트 버전',

    -- 타임스탬프
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '분석일',

    -- 제약 조건
    FOREIGN KEY (repo_id) REFERENCES repositories(repo_id) ON DELETE CASCADE,
    INDEX idx_repo_analysis (repo_id, created_at DESC),
    INDEX idx_project_type (project_type)

) ENGINE=InnoDB COMMENT='레포지토리 코드 분석 결과';

-- ============================================
-- DOMAIN: Resource Monitoring
-- ============================================

-- 실시간 리소스 메트릭 (5분 단위 수집)
CREATE TABLE resource_metrics (
    metric_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '메트릭 고유 ID',
    repo_id BIGINT UNSIGNED NOT NULL COMMENT '레포지토리 ID',

    -- 시간 정보
    collected_at TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) COMMENT '수집 시간',

    -- CPU 메트릭
    cpu_usage_percent DECIMAL(5,2) NOT NULL COMMENT 'CPU 사용률 (%)',
    cpu_throttled_percent DECIMAL(5,2) DEFAULT 0 COMMENT 'CPU 스로틀링 (%)',

    -- 메모리 메트릭
    memory_usage_gb DECIMAL(8,2) NOT NULL COMMENT '메모리 사용량 (GB)',
    memory_usage_percent DECIMAL(5,2) NOT NULL COMMENT '메모리 사용률 (%)',
    memory_cache_gb DECIMAL(8,2) DEFAULT 0 COMMENT '캐시 메모리 (GB)',

    -- 네트워크 메트릭
    network_in_mbps DECIMAL(10,2) DEFAULT 0 COMMENT '인바운드 (Mbps)',
    network_out_mbps DECIMAL(10,2) DEFAULT 0 COMMENT '아웃바운드 (Mbps)',
    network_latency_ms DECIMAL(8,2) DEFAULT 0 COMMENT '네트워크 지연 (ms)',

    -- 애플리케이션 메트릭
    request_per_second INT UNSIGNED DEFAULT 0 COMMENT '초당 요청 수',
    response_time_ms DECIMAL(8,2) DEFAULT 0 COMMENT '평균 응답 시간 (ms)',
    error_rate_percent DECIMAL(5,2) DEFAULT 0 COMMENT '에러율 (%)',

    -- 인스턴스 정보
    running_instances SMALLINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '실행 중인 인스턴스',

    -- 시간 컨텍스트 (LSTM Feature)
    hour_of_day TINYINT UNSIGNED GENERATED ALWAYS AS (HOUR(collected_at)) STORED COMMENT '시간',
    day_of_week TINYINT UNSIGNED GENERATED ALWAYS AS (DAYOFWEEK(collected_at)) STORED COMMENT '요일',

    -- 제약 조건
    FOREIGN KEY (repo_id) REFERENCES repositories(repo_id) ON DELETE CASCADE,
    INDEX idx_repo_time (repo_id, collected_at DESC),
    INDEX idx_collected_at (collected_at),
    INDEX idx_cpu_memory (cpu_usage_percent, memory_usage_percent)

) ENGINE=InnoDB COMMENT='실시간 리소스 사용량 메트릭';

-- LSTM 모델 예측 결과
CREATE TABLE predictions (
    prediction_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '예측 고유 ID',
    repo_id BIGINT UNSIGNED NOT NULL COMMENT '레포지토리 ID',

    -- 예측 시점
    created_at TIMESTAMP(3) DEFAULT CURRENT_TIMESTAMP(3) COMMENT '예측 생성 시간',
    prediction_start TIMESTAMP NOT NULL COMMENT '예측 시작 시점',
    prediction_horizon_hours INT DEFAULT 24 COMMENT '예측 기간 (시간)',

    -- 입력 컨텍스트
    input_context JSON NOT NULL COMMENT '예측 입력 컨텍스트 {코드복잡도, 의존성 등}',
    current_metrics JSON NOT NULL COMMENT '현재 메트릭 스냅샷',

    -- 24시간 예측값 (JSON 배열)
    predicted_cpu JSON NOT NULL COMMENT 'CPU 사용률 예측 [24개 값]'
        CHECK (JSON_TYPE(predicted_cpu) = 'ARRAY'),
    predicted_memory JSON NOT NULL COMMENT '메모리 사용률 예측 [24개 값]'
        CHECK (JSON_TYPE(predicted_memory) = 'ARRAY'),
    predicted_requests JSON COMMENT '요청 수 예측 [24개 값]',

    -- 신뢰 구간
    confidence_intervals JSON COMMENT '예측 신뢰구간 {lower, upper}',
    confidence_score DECIMAL(3,2) DEFAULT 0.95 COMMENT '전체 신뢰도 점수',

    -- 예측 요약
    peak_cpu_hour TINYINT UNSIGNED COMMENT '최대 CPU 예상 시간',
    peak_cpu_value DECIMAL(5,2) COMMENT '최대 CPU 예상값',
    avg_predicted_cpu DECIMAL(5,2) NOT NULL COMMENT '평균 예측 CPU',
    avg_predicted_memory DECIMAL(5,2) NOT NULL COMMENT '평균 예측 메모리',

    -- 스케일링 추천
    recommended_min_instances TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '최소 권장 인스턴스',
    recommended_max_instances TINYINT UNSIGNED NOT NULL DEFAULT 10 COMMENT '최대 권장 인스턴스',
    scaling_strategy ENUM('conservative', 'balanced', 'aggressive')
        DEFAULT 'balanced' COMMENT '스케일링 전략',

    -- 모델 정보
    model_version VARCHAR(20) NOT NULL DEFAULT 'lstm_v1.0' COMMENT '모델 버전',
    model_accuracy DECIMAL(5,4) COMMENT 'R² Score',

    -- 제약 조건
    FOREIGN KEY (repo_id) REFERENCES repositories(repo_id) ON DELETE CASCADE,
    INDEX idx_repo_predictions (repo_id, created_at DESC),
    INDEX idx_prediction_time (prediction_start)

) ENGINE=InnoDB COMMENT='LSTM 모델 24시간 예측 결과';

-- ============================================
-- DOMAIN: Anomaly Detection
-- ============================================

-- 이상 탐지 결과 (Isolation Forest)
CREATE TABLE anomaly_detections (
    anomaly_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '이상 탐지 ID',
    repo_id BIGINT UNSIGNED NOT NULL COMMENT '레포지토리 ID',

    -- 탐지 정보
    detected_at TIMESTAMP(3) DEFAULT CURRENT_TIMESTAMP(3) COMMENT '탐지 시간',
    anomaly_start TIMESTAMP NOT NULL COMMENT '이상 시작 시간',
    anomaly_end TIMESTAMP NULL COMMENT '이상 종료 시간',

    -- 이상 분류
    anomaly_type ENUM('cpu_spike', 'memory_spike', 'cpu_drop', 'memory_drop',
                     'network_anomaly', 'error_spike', 'pattern_deviation')
        NOT NULL COMMENT '이상 유형',
    severity ENUM('low', 'medium', 'high', 'critical') NOT NULL COMMENT '심각도',

    -- 이상 수치
    anomaly_score DECIMAL(10,6) NOT NULL COMMENT 'Isolation Forest 이상 점수',
    deviation_percent DECIMAL(8,2) COMMENT '정상 대비 편차율 (%)',

    -- 영향받은 메트릭
    affected_metrics JSON NOT NULL COMMENT '영향받은 메트릭 리스트',
    metric_values JSON NOT NULL COMMENT '이상 시점 메트릭 값',
    baseline_values JSON COMMENT '정상 기준값',

    -- 원인 분석
    probable_cause VARCHAR(200) COMMENT '추정 원인',
    correlation_events JSON COMMENT '상관 이벤트',

    -- 대응 액션
    auto_scaled BOOLEAN DEFAULT FALSE COMMENT '자동 스케일링 실행 여부',
    alert_sent BOOLEAN DEFAULT FALSE COMMENT '알림 전송 여부',
    resolved BOOLEAN DEFAULT FALSE COMMENT '해결 여부',
    resolved_at TIMESTAMP NULL COMMENT '해결 시간',

    -- 제약 조건
    FOREIGN KEY (repo_id) REFERENCES repositories(repo_id) ON DELETE CASCADE,
    INDEX idx_repo_anomalies (repo_id, detected_at DESC),
    INDEX idx_severity_time (severity, detected_at),
    INDEX idx_unresolved (resolved, severity)

) ENGINE=InnoDB COMMENT='Isolation Forest 이상 탐지 결과';

-- ============================================
-- DOMAIN: Auto Scaling
-- ============================================

-- 자동 스케일링 액션
CREATE TABLE scaling_actions (
    action_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '액션 고유 ID',
    repo_id BIGINT UNSIGNED NOT NULL COMMENT '레포지토리 ID',
    predAiction_id BIGINT UNSIGNED COMMENT '관련 예측 ID',
    anomaly_id BIGINT UNSIGNED COMMENT '관련 이상 탐지 ID',

    -- 액션 정보
    triggered_at TIMESTAMP(3) DEFAULT CURRENT_TIMESTAMP(3) COMMENT '트리거 시간',
    executed_at TIMESTAMP NULL COMMENT '실행 시간',

    -- 스케일링 타입
    action_type ENUM('scale_up', 'scale_down', 'scale_to_zero', 'maintain')
        NOT NULL COMMENT '액션 타입',
    trigger_source ENUM('prediction', 'anomaly', 'manual', 'scheduled')
        NOT NULL COMMENT '트리거 소스',

    -- 인스턴스 변경
    instances_before SMALLINT UNSIGNED NOT NULL COMMENT '이전 인스턴스 수',
    instances_after SMALLINT UNSIGNED NOT NULL COMMENT '이후 인스턴스 수',
    instance_type VARCHAR(50) COMMENT '인스턴스 타입 (t3.medium 등)',

    -- 리소스 변경
    cpu_limit_before DECIMAL(5,2) COMMENT '이전 CPU 제한',
    cpu_limit_after DECIMAL(5,2) COMMENT '이후 CPU 제한',
    memory_limit_before DECIMAL(8,2) COMMENT '이전 메모리 제한 (GB)',
    memory_limit_after DECIMAL(8,2) COMMENT '이후 메모리 제한 (GB)',

    -- 비용 영향
    estimated_cost_change DECIMAL(10,2) COMMENT '예상 비용 변화 ($/hour)',

    -- 실행 결과
    status ENUM('pending', 'executing', 'success', 'failed', 'rolled_back')
        DEFAULT 'pending' COMMENT '실행 상태',
    error_message TEXT COMMENT '에러 메시지',

    -- 클라우드 정보
    cloud_provider ENUM('aws', 'gcp', 'azure') COMMENT '클라우드 제공자',
    region VARCHAR(50) COMMENT '리전',

    -- 제약 조건
    FOREIGN KEY (repo_id) REFERENCES repositories(repo_id) ON DELETE CASCADE,
    FOREIGN KEY (prediction_id) REFERENCES predictions(prediction_id) ON DELETE SET NULL,
    FOREIGN KEY (anomaly_id) REFERENCES anomaly_detections(anomaly_id) ON DELETE SET NULL,
    INDEX idx_repo_actions (repo_id, triggered_at DESC),
    INDEX idx_action_status (status, triggered_at)

) ENGINE=InnoDB COMMENT='자동 스케일링 액션 로그';

-- ============================================
-- DOMAIN: Alerts & Notifications
-- ============================================

-- 알림 설정
CREATE TABLE alert_configurations (
    config_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '설정 고유 ID',
    user_id BIGINT UNSIGNED NOT NULL COMMENT '사용자 ID',
    repo_id BIGINT UNSIGNED COMMENT '레포지토리 ID (NULL=전체)',

    -- 알림 채널
    discord_webhook VARCHAR(500) COMMENT 'Discord Webhook URL',
    slack_webhook VARCHAR(500) COMMENT 'Slack Webhook URL',
    email_enabled BOOLEAN DEFAULT TRUE COMMENT '이메일 알림 여부',

    -- 알림 조건
    cpu_threshold DECIMAL(5,2) DEFAULT 80 COMMENT 'CPU 임계값 (%)',
    memory_threshold DECIMAL(5,2) DEFAULT 80 COMMENT '메모리 임계값 (%)',
    error_rate_threshold DECIMAL(5,2) DEFAULT 5 COMMENT '에러율 임계값 (%)',
    anomaly_severity_min ENUM('low', 'medium', 'high', 'critical')
        DEFAULT 'medium' COMMENT '최소 이상 심각도',

    -- 알림 빈도
    cooldown_minutes INT DEFAULT 30 COMMENT '재알림 쿨다운 (분)',

    -- 활성화 상태
    is_active BOOLEAN DEFAULT TRUE COMMENT '활성화 여부',

    -- 타임스탬프
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 제약 조건
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (repo_id) REFERENCES repositories(repo_id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_repo (user_id, repo_id),
    INDEX idx_active_configs (is_active, user_id)

) ENGINE=InnoDB COMMENT='사용자별 알림 설정';

-- 알림 이력
CREATE TABLE alert_history (
    alert_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '알림 고유 ID',
    repo_id BIGINT UNSIGNED NOT NULL COMMENT '레포지토리 ID',

    -- 알림 정보
    created_at TIMESTAMP(3) DEFAULT CURRENT_TIMESTAMP(3) COMMENT '생성 시간',
    sent_at TIMESTAMP NULL COMMENT '전송 시간',

    -- 알림 내용
    alert_type ENUM('threshold', 'anomaly', 'scaling', 'error') NOT NULL COMMENT '알림 유형',
    severity ENUM('info', 'warning', 'error', 'critical') NOT NULL COMMENT '심각도',
    title VARCHAR(200) NOT NULL COMMENT '알림 제목',
    message TEXT NOT NULL COMMENT '알림 내용',

    -- 트리거 정보
    trigger_source VARCHAR(100) COMMENT '트리거 소스',
    trigger_value DECIMAL(10,2) COMMENT '트리거 값',
    threshold_value DECIMAL(10,2) COMMENT '임계값',

    -- 전송 채널
    channels JSON NOT NULL COMMENT '전송 채널 ["discord", "email"]',

    -- 전송 결과
    status ENUM('pending', 'sent', 'failed') DEFAULT 'pending' COMMENT '전송 상태',
    error_message TEXT COMMENT '전송 실패 사유',

    -- 메트릭 스냅샷
    metrics_snapshot JSON COMMENT '알림 시점 메트릭',

    -- 제약 조건
    FOREIGN KEY (repo_id) REFERENCES repositories(repo_id) ON DELETE CASCADE,
    INDEX idx_repo_alerts (repo_id, created_at DESC),
    INDEX idx_alert_status (status, created_at)

) ENGINE=InnoDB COMMENT='알림 전송 이력';

-- ============================================
-- DOMAIN: Model Management
-- ============================================

-- 모델 버전 관리
CREATE TABLE model_versions (
    version_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '버전 고유 ID',

    -- 모델 정보
    model_name VARCHAR(50) NOT NULL COMMENT '모델 이름',
    version VARCHAR(20) NOT NULL COMMENT '버전 번호',
    model_type ENUM('lstm', 'gru', 'transformer', 'ensemble')
        DEFAULT 'lstm' COMMENT '모델 타입',

    -- 학습 정보
    trained_at TIMESTAMP NOT NULL COMMENT '학습 시간',
    training_duration_minutes INT UNSIGNED COMMENT '학습 소요 시간 (분)',
    training_samples INT UNSIGNED COMMENT '학습 샘플 수',

    -- 성능 메트릭
    train_r2 DECIMAL(5,4) COMMENT '훈련 R² Score',
    val_r2 DECIMAL(5,4) COMMENT '검증 R² Score',
    test_r2 DECIMAL(5,4) COMMENT '테스트 R² Score',
    mae DECIMAL(8,4) COMMENT 'Mean Absolute Error',
    rmse DECIMAL(8,4) COMMENT 'Root Mean Square Error',

    -- 모델 파일
    model_path VARCHAR(500) COMMENT '모델 파일 경로',
    model_size_mb DECIMAL(10,2) COMMENT '모델 크기 (MB)',

    -- 하이퍼파라미터
    hyperparameters JSON COMMENT '하이퍼파라미터 설정',
    features_used JSON COMMENT '사용된 Feature 목록',

    -- 상태
    is_active BOOLEAN DEFAULT FALSE COMMENT '현재 활성 모델 여부',
    deployment_status ENUM('testing', 'staging', 'production')
        DEFAULT 'testing' COMMENT '배포 상태',

    -- 메타데이터
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100) COMMENT '생성자',

    -- 제약 조건
    UNIQUE KEY uk_model_version (model_name, version),
    INDEX idx_active_model (is_active, model_name),
    INDEX idx_performance (test_r2 DESC)

) ENGINE=InnoDB COMMENT='ML 모델 버전 관리';

-- ============================================
-- DOMAIN: Cost Optimization
-- ============================================

-- 비용 최적화 분석
CREATE TABLE cost_analysis (
    analysis_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '분석 고유 ID',
    repo_id BIGINT UNSIGNED NOT NULL COMMENT '레포지토리 ID',

    -- 분석 기간
    analysis_date DATE NOT NULL COMMENT '분석 날짜',

    -- 실제 비용
    actual_cost_daily DECIMAL(10,2) NOT NULL COMMENT '일일 실제 비용 ($)',
    actual_instance_hours INT UNSIGNED COMMENT '실제 인스턴스 시간',

    -- 최적화된 비용
    optimized_cost_daily DECIMAL(10,2) NOT NULL COMMENT '최적화 비용 ($)',
    optimized_instance_hours INT UNSIGNED COMMENT '최적화 인스턴스 시간',

    -- 절감액
    saved_amount DECIMAL(10,2) GENERATED ALWAYS AS
        (actual_cost_daily - optimized_cost_daily) STORED COMMENT '절감액 ($)',
    savings_percent DECIMAL(5,2) GENERATED ALWAYS AS
        ((actual_cost_daily - optimized_cost_daily) / actual_cost_daily * 100)
        STORED COMMENT '절감률 (%)',

    -- 리소스 효율성
    avg_cpu_utilization DECIMAL(5,2) COMMENT '평균 CPU 활용률 (%)',
    avg_memory_utilization DECIMAL(5,2) COMMENT '평균 메모리 활용률 (%)',
    over_provisioned_hours INT UNSIGNED DEFAULT 0 COMMENT '과다 할당 시간',
    under_provisioned_hours INT UNSIGNED DEFAULT 0 COMMENT '부족 할당 시간',

    -- 인스턴스 타입 분석
    instance_type_distribution JSON COMMENT '인스턴스 타입별 사용 분포',
    spot_instance_usage_percent DECIMAL(5,2) DEFAULT 0 COMMENT 'Spot 인스턴스 사용률 (%)',

    -- 타임스탬프
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 제약 조건
    FOREIGN KEY (repo_id) REFERENCES repositories(repo_id) ON DELETE CASCADE,
    UNIQUE KEY uk_repo_date (repo_id, analysis_date),
    INDEX idx_analysis_date (analysis_date DESC),
    INDEX idx_savings (savings_percent DESC)

) ENGINE=InnoDB COMMENT='비용 최적화 분석 결과';

-- ============================================
-- VIEWS: 대시보드용 뷰
-- ============================================

-- 현재 리소스 사용 현황
CREATE VIEW v_current_resource_status AS
SELECT
    r.repo_id,
    r.repo_name,
    rm.cpu_usage_percent,
    rm.memory_usage_percent,
    rm.running_instances,
    rm.request_per_second,
    rm.error_rate_percent,
    rm.collected_at
FROM repositories r
INNER JOIN resource_metrics rm ON r.repo_id = rm.repo_id
WHERE rm.collected_at = (
    SELECT MAX(collected_at)
    FROM resource_metrics
    WHERE repo_id = r.repo_id
);

-- 24시간 예측 요약
CREATE VIEW v_prediction_summary AS
SELECT
    p.repo_id,
    r.repo_name,
    p.prediction_id,
    p.created_at,
    p.avg_predicted_cpu,
    p.avg_predicted_memory,
    p.peak_cpu_value,
    p.peak_cpu_hour,
    p.recommended_min_instances,
    p.recommended_max_instances,
    p.confidence_score
FROM predictions p
INNER JOIN repositories r ON p.repo_id = r.repo_id
WHERE p.created_at = (
    SELECT MAX(created_at)
    FROM predictions
    WHERE repo_id = p.repo_id
);

-- 비용 절감 대시보드
CREATE VIEW v_cost_savings_dashboard AS
SELECT
    r.repo_name,
    DATE_FORMAT(ca.analysis_date, '%Y-%m') as month,
    SUM(ca.actual_cost_daily) as total_actual_cost,
    SUM(ca.optimized_cost_daily) as total_optimized_cost,
    SUM(ca.saved_amount) as total_saved,
    AVG(ca.savings_percent) as avg_savings_percent,
    AVG(ca.avg_cpu_utilization) as avg_cpu_util,
    AVG(ca.avg_memory_utilization) as avg_mem_util
FROM cost_analysis ca
INNER JOIN repositories r ON ca.repo_id = r.repo_id
WHERE ca.analysis_date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
GROUP BY r.repo_id, DATE_FORMAT(ca.analysis_date, '%Y-%m')
ORDER BY month DESC;


^G Help                                             ^O Write Out                                        ^W Where Is                                         ^K Cut                                              ^T Execute                                          ^C Location                                         M-U Undo                                            M-A Set Mark                                        M-] To Bracket                                      M-Q Previous                                        ^B Back                                             ^◂ Prev Word                                        ^A Home                                             ^P Prev Line                                        M-▴ Scroll Up                                       ^▴ Prev Block                                       M-( Begin of Paragr.                                ^Y Prev Page                                        M-\ First Line                                      M-◂ Prev File                                       ^I Tab                                              ^H Backspace                                        M-Bsp Chop Left                                     M-T Cut Till End                                    M-D Word Count                                      M-} Indent                                          M-3 Comment Lines                                   M-: Record                                          M-Del Zap                                           M-PgUp Up to anchor                                 F12 Spell Check                                     M-F Formatter                                       ^L Center
^X Exit                                             ^R Read File                                        ^\ Replace                                          ^U Paste                                            ^J Justify                                          ^/ Go To Line                                       M-E Redo                                            M-6 Copy                                            ^Q Where Was                                        M-W Next                                            ^F Forward                                          ^▸ Next Word                                        ^E End                                              ^N Next Line                                        M-▾ Scroll Down                                     ^▾ Next Block                                       M-) End of Paragraph                                ^V Next Page                                        M-/ Last Line                                       M-▸ Next File                                       ^M Enter                                            ^D Delete                                           ^Del Chop Right                                     M-J Full Justify                                    M-V Verbatim                                        M-{ Unindent                                        ^] Complete                                         M-; Run Macro                                       M-Ins Anchor                                        M-PgDn Down to anchor                               M-B Linter                                          ^L Refresh                                          ^S Save
